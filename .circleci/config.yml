version: "2.1"
orbs:
  docker: circleci/docker@2.1.4

jobs:
  lint-test-push:
    executor: docker/machine
    steps:
      - checkout
      - docker/dockerlint:
          dockerfile: Dockerfile
          treat-warnings-as-errors: true

      - run:
          command: go test -v -short --count=1 $(go list ./...)

  build-and-push:
    executor: docker/docker
    steps:
      - setup_remote_docker
      - checkout
      - docker/check
      - docker/build:
          dockerfile: Dockerfile
          image: ghcr.io/harisrahmannst/"${IMAGE_TAG1}"
      - docker/push:
          registry: ghcr.io
          image: ghcr.io/harisrahmannst/"${IMAGE_TAG1}"


workflows:
  lint-and-build-dockerfile:
    jobs:
      - lint-test-push
      - build-and-push:
          requires:
            - lint-test-push